<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading P/L Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs (Compat Version) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        /* --- Base Styles --- */
        body {
            font-family: 'Poppins', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .main-container {
            max-width: 420px;
            margin: auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 1.5rem; /* Increased spacing */
            transition: background-color 0.3s ease;
        }
        .calc-btn {
            width: 100%;
            aspect-ratio: 1 / 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: 600;
            border-radius: 1.25rem; /* Slightly more rounded rectangle */
            box-shadow: 0 4px 15px -1px rgba(0,0,0,0.1);
            transition: all 0.15s ease-in-out;
            border: 2px solid transparent;
            cursor: pointer;
        }
        .calc-btn:active {
            transform: scale(0.96);
            box-shadow: 0 2px 5px -1px rgba(0,0,0,0.1);
        }
        .btn { @apply font-bold rounded-lg shadow-md transition-transform transform hover:scale-105 active:scale-95; }
        .modal {
            @apply fixed inset-0 flex items-center justify-center p-4 z-50;
            background-color: rgba(0, 0, 0, 0.5);
            opacity: 0;
            transform: scale(0.95);
            transition: opacity 0.2s ease, transform 0.2s ease;
            pointer-events: none;
        }
        .modal.active {
            opacity: 1;
            transform: scale(1);
            pointer-events: auto;
        }
        .modal-content {
            @apply rounded-2xl shadow-2xl w-full max-w-sm text-white p-6;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        .icon-btn { @apply p-1 transition-colors duration-200; }
        .stats-label { @apply text-sm font-medium; }
        .stats-value { @apply text-lg font-semibold; }
        .form-input { @apply w-full rounded-md p-2 mt-1; }

        /* --- Data Ring Styles --- */
        .data-ring-container {
            position: relative;
            width: 80px;
            height: 80px;
            cursor: pointer;
        }
        .data-ring-svg {
            transform: rotate(-90deg);
            width: 100%;
            height: 100%;
            transition: opacity 0.2s ease-in-out;
        }
        .data-ring-circle {
            transition: stroke-dashoffset 0.5s ease-out;
        }
        .data-ring-text {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            pointer-events: none;
        }
        .data-ring-text .value { font-size: 1.75rem; font-weight: 700; line-height: 1; }
        .data-ring-details { display: none; }

        .data-ring-container:hover .data-ring-total,
        .data-ring-container.show-details .data-ring-total {
            display: none;
        }
        .data-ring-container:hover .data-ring-details,
        .data-ring-container.show-details .data-ring-details {
            display: flex;
        }
        .data-ring-container:hover .data-ring-svg,
        .data-ring-container.show-details .data-ring-svg {
            opacity: 0.2;
        }
        .data-ring-details .profit-value { font-size: 1.1rem; font-weight: 700; line-height: 1.2; }
        .data-ring-details .wl-value { font-size: 0.8rem; font-weight: 500; }


        /* --- Dark Theme (Default) --- */
        .dark-theme { background: linear-gradient(to top, #000000, #111111); color: #F9FAFB; }
        .dark-theme .main-container { background: transparent; }
        .dark-theme .header-text, .dark-theme .score-text { color: #fff; }
        .dark-theme .sub-text { color: #a0aec0; }
        .dark-theme .btn-positive { background-color: #15803d; color: white; }
        .dark-theme .btn-positive:hover { background-color: #16a34a; }
        .dark-theme .btn-negative { background-color: #b91c1c; color: white; }
        .dark-theme .btn-negative:hover { background-color: #dc2626; }
        .dark-theme .btn-neutral { background-color: #374151; color: white; }
        .dark-theme .btn-neutral:hover { background-color: #4b5563; }
        .dark-theme .btn-secondary, .dark-theme .btn-action, .dark-theme .dropdown, .dark-theme .history-item { background-color: #1a202c; border-color: #2d3748; color: #e2e8f0; }
        .dark-theme .modal-content { background-color: rgba(26, 32, 44, 0.8); border: 1px solid rgba(255, 255, 255, 0.1); }
        .dark-theme .btn-action { background-color: #2b6cb0; }
        .dark-theme .btn-action:hover { background-color: #3182ce; }
        .dark-theme .stats-value.positive, .dark-theme .profit-positive { color: #48bb78; }
        .dark-theme .stats-value.negative, .dark-theme .profit-negative { color: #f56565; }
        .dark-theme .icon-btn { color: #a0aec0; }
        .dark-theme .icon-btn:hover { color: #fff; }
        .dark-theme .score-glow-positive { text-shadow: 0 0 15px rgba(72, 187, 120, 0.5); }
        .dark-theme .score-glow-negative { text-shadow: 0 0 15px rgba(245, 101, 101, 0.5); }
        .dark-theme .form-input { background-color: #2d3748; border: 1px solid #4a5568; }
        .dark-theme .form-input::placeholder { color: #718096; }
        .dark-theme .ring-track { stroke: #2d3748; }
        .dark-theme .ring-wins { stroke: #48bb78; }
        .dark-theme .ring-losses { stroke: #f56565; }
        .dark-theme .data-ring-text { color: #e2e8f0; }
        .dark-theme .stats-card { background-color: #2d3748; }

        /* --- Ice Theme --- */
        .ice-theme { background: linear-gradient(to top, #f3e5f5, #e0f7fa); color: #2d3748; }
        .ice-theme .main-container { background: transparent; }
        .ice-theme .header-text, .ice-theme .score-text { color: #1a202c; }
        .ice-theme .sub-text { color: #718096; }
        .ice-theme .btn-positive { background-color: transparent; color: #3182ce; border-color: #3182ce; }
        .ice-theme .btn-positive:hover { background-color: #3182ce; color: white; }
        .ice-theme .btn-negative { background-color: transparent; color: #805ad5; border-color: #805ad5; }
        .ice-theme .btn-negative:hover { background-color: #805ad5; color: white; }
        .ice-theme .btn-neutral { background-color: #e2e8f0; color: #2d3748; }
        .ice-theme .btn-neutral:hover { background-color: #cbd5e0; }
        .ice-theme .btn-secondary, .ice-theme .btn-action, .ice-theme .dropdown, .ice-theme .history-item { background-color: #fff; border-color: #e2e8f0; color: #2d3748; box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1); }
        .ice-theme .modal-content { background-color: rgba(255, 255, 255, 0.7); border: 1px solid rgba(0, 0, 0, 0.05); }
        .ice-theme .btn-action { background-color: #805ad5; color: white; }
        .ice-theme .btn-action:hover { background-color: #9f7aea; }
        .ice-theme .stats-value.positive, .ice-theme .profit-positive { color: #3182ce; }
        .ice-theme .stats-value.negative, .ice-theme .profit-negative { color: #805ad5; }
        .ice-theme .icon-btn { color: #718096; }
        .ice-theme .icon-btn:hover { color: #1a202c; }
        .ice-theme .score-glow-positive { text-shadow: 0 0 15px rgba(56, 161, 105, 0.4); }
        .ice-theme .score-glow-negative { text-shadow: 0 0 15px rgba(197, 48, 48, 0.4); }
        .ice-theme .form-input { background-color: #fff; border: 1px solid #cbd5e0; color: #2d3748; }
        .ice-theme .form-input::placeholder { color: #a0aec0; }
        .ice-theme .ring-track { stroke: #e2e8f0; }
        .ice-theme .ring-wins { stroke: #4299e1; }
        .ice-theme .ring-losses { stroke: #9f7aea; }
        .ice-theme .data-ring-text { color: #2d3748; }
        .ice-theme .stats-card { background-color: #fff; }
    </style>
</head>
<body class="dark-theme">

    <div class="main-container">
        <!-- Header -->
        <header class="flex justify-between items-center h-20">
            <button id="theme-switcher" class="icon-btn">
                <!-- Sun/Moon Icon will be injected here by JS -->
            </button>
            <div class="data-ring-container" id="data-ring">
                <svg class="data-ring-svg" viewBox="0 0 36 36">
                    <path class="data-ring-circle ring-track" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke-width="3"></path>
                    <path id="ring-losses" class="data-ring-circle ring-losses" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke-width="3"></path>
                    <path id="ring-wins" class="data-ring-circle ring-wins" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke-width="3"></path>
                </svg>
                <div class="data-ring-text">
                    <div class="data-ring-total">
                        <span class="value" id="trades-tracker">0</span>
                    </div>
                    <div class="data-ring-details">
                         <div class="flex flex-col items-center">
                            <span class="profit-value" id="live-profit-detail"></span>
                            <div class="flex space-x-2 mt-1">
                                <span class="wl-value" id="wins-tracker-detail">W: 0</span>
                                <span class="wl-value" id="losses-tracker-detail">L: 0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Score Display -->
        <div class="text-center my-8 flex-grow flex flex-col justify-center">
            <h2 class="text-8xl font-bold score-text transition-shadow duration-300" id="main-score">0.0</h2>
        </div>

        <!-- Template Selector -->
        <div class="flex items-center justify-center space-x-2 mb-6">
            <select id="template-selector" class="dropdown rounded-md px-3 py-2 text-sm font-medium focus:outline-none focus:ring-2 focus:ring-blue-500"></select>
            <button id="calc-btn" title="Calculator" class="icon-btn btn btn-secondary !p-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M12 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h8zM4 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H4z"/>
                    <path d="M4 2.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-.5.5h-7a.5.5 0 0 1-.5-.5v-2zm0 4a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm0 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm0 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm3-6a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm0 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm0 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm3-6a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm0 3a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v4a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-4z"/>
                </svg>
            </button>
             <button id="edit-templates-btn" class="btn btn-secondary text-sm !py-2 !px-3">Edit</button>
        </div>

        <!-- Buttons Grid -->
        <div id="buttons-container" class="grid grid-cols-3 gap-4"></div>
        
        <!-- Action Buttons -->
        <div class="grid grid-cols-3 gap-4 pt-6 mt-6 border-t border-gray-700">
             <button id="undo-btn" class="btn btn-secondary col-span-1 flex justify-center items-center"></button>
             <button id="history-btn" class="btn btn-secondary col-span-1 flex justify-center items-center"></button>
             <button id="reset-btn" class="btn btn-secondary col-span-1 flex justify-center items-center"></button>
        </div>
        
        <!-- Save Button -->
        <div class="pt-4">
             <button id="save-btn" class="btn btn-action w-full">Save Session</button>
        </div>

        <!-- Saved Sessions Log (Toggled) -->
        <div id="saved-sessions-container" class="pt-4 space-y-2 hidden">
            <div class="flex justify-between items-center border-b border-gray-700 pb-2">
                <h3 class="text-lg font-semibold header-text">Saved Sessions</h3>
                <div class="flex items-center space-x-3">
                    <button id="export-all-btn" title="Export All Sessions" class="icon-btn"></button>
                    <button id="wipe-sessions-btn" title="Wipe All Sessions" class="icon-btn"></button>
                </div>
            </div>
            <div id="sessions-log" class="text-sm space-y-2 max-h-48 overflow-y-auto"></div>
        </div>
    </div>

    <!-- Modals -->
    <div id="stats-modal" class="modal"><div class="modal-content space-y-4"><div class="flex justify-between items-center"><h3 class="text-xl font-bold">Session Statistics</h3><button id="close-stats-btn" class="icon-btn"></button></div><div id="stats-display" class="space-y-3 pt-2"></div></div></div>
    <div id="delete-session-modal" class="modal"><div class="modal-content space-y-4 text-center"><h3 class="text-lg font-bold">Delete Session?</h3><p class="text-sm sub-text">This cannot be undone.</p><div class="flex justify-center space-x-4"><button id="cancel-delete-session-btn" class="btn btn-secondary">Cancel</button><button id="confirm-delete-session-btn" class="btn btn-negative px-4 py-2">Delete</button></div></div></div>
    <div id="calc-modal" class="modal"><div class="modal-content space-y-4"><h3 class="text-lg font-bold">Edit Calculation</h3><p class="text-sm sub-text">Separate values with a space.</p><textarea id="calc-input" class="form-input h-24"></textarea><div class="flex justify-end space-x-2"><button id="cancel-calc-btn" class="btn btn-secondary">Cancel</button><button id="update-calc-btn" class="btn btn-action">Update</button></div></div></div>
    <div id="reset-modal" class="modal"><div class="modal-content space-y-4 text-center"><h3 class="text-lg font-bold">Are you sure?</h3><p class="text-sm sub-text">This will reset the current session.</p><div class="flex justify-center space-x-4"><button id="cancel-reset-btn" class="btn btn-secondary">Cancel</button><button id="confirm-reset-btn" class="btn btn-negative px-4 py-2">Reset</button></div></div></div>
    <div id="wipe-modal" class="modal"><div class="modal-content space-y-4 text-center"><h3 class="text-lg font-bold">Wipe All Sessions?</h3><p class="text-sm sub-text">This cannot be undone.</p><div class="flex justify-center space-x-4"><button id="cancel-wipe-btn" class="btn btn-secondary">Cancel</button><button id="confirm-wipe-btn" class="btn btn-negative px-4 py-2">Confirm Wipe</button></div></div></div>
    <div id="save-modal" class="modal"><div class="modal-content space-y-4"><h3 class="text-lg font-bold">Save Session</h3><div><label for="save-note" class="text-sm font-medium">Note</label><input type="text" id="save-note" class="form-input" placeholder="e.g., London Session"></div><div><label for="save-date" class="text-sm font-medium">Date</label><input type="date" id="save-date" class="form-input"></div><div><label class="text-sm font-medium">Session Time</label><select id="session-time-selector" class="form-input"><option value="8:30 - 12:30">8:30 - 12:30</option><option value="9:00 - 12:30">9:00 - 12:30</option><option value="9:30-12:30">9:30-12:30</option><option value="12:30-14:50">12:30-14:50</option><option value="Custom">Custom</option></select></div><div id="custom-time-inputs" class="hidden grid grid-cols-2 gap-2"><div><label for="start-time" class="text-xs">Start</label><input type="time" id="start-time" class="form-input"></div><div><label for="end-time" class="text-xs">End</label><input type="time" id="end-time" class="form-input"></div></div><div class="flex justify-end space-x-2"><button id="cancel-save-btn" class="btn btn-secondary">Cancel</button><button id="confirm-save-btn" class="btn btn-action">Save</button></div></div></div>
    <div id="edit-templates-modal" class="modal"><div class="modal-content space-y-4"><h3 class="text-lg font-bold">Edit Templates</h3><div><label for="template-edit-selector" class="text-sm">Select Template to Edit:</label><select id="template-edit-selector" class="form-input"></select></div><div><label for="template-name-input" class="text-sm">Template Name:</label><input type="text" id="template-name-input" class="form-input"></div><div class="grid grid-cols-2 gap-4"><div><label for="instrument-selector" class="text-sm">Instrument</label><select id="instrument-selector" class="form-input"><option value="MES">MES</option><option value="ES">ES</option><option value="MNQ">MNQ</option><option value="NQ">NQ</option></select></div><div><label class="text-sm">Point Value</label><span id="point-value-display" class="form-input bg-gray-700/50 flex items-center justify-center font-semibold"></span></div></div><div><label for="commission-input" class="text-sm">Commission ($ per trade)</label><input type="number" id="commission-input" class="form-input" placeholder="e.g., 1.24"></div><div><label for="positive-buttons-input" class="text-sm">Positive Buttons (comma separated):</label><input type="text" id="positive-buttons-input" class="form-input"></div><div><label for="negative-buttons-input" class="text-sm">Negative Buttons (comma separated):</label><input type="text" id="negative-buttons-input" class="form-input"></div><div class="flex justify-between items-center pt-4"><button id="delete-template-btn" class="btn bg-red-600 text-white text-xs px-3 py-2">Delete</button><div class="space-x-2"><button id="cancel-edit-templates-btn" class="btn btn-secondary">Close</button><button id="save-template-btn" class="btn btn-action">Save</button></div></div></div></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // This flag ensures the app only initializes once.
            if (window.myTradingAppInitialized) {
                return;
            }
            window.myTradingAppInitialized = true;

            // --- FIREBASE CONFIG (DO NOT EDIT IN PREVIEW) ---
            const firebaseConfig = {
  apiKey: "AIzaSyAjtH-8qhMjQCgNfwq8xO90gu8cHA9dQeA",
  authDomain: "modern-tracker.firebaseapp.com",
  projectId: "modern-tracker",
  storageBucket: "modern-tracker.firebasestorage.app",
  messagingSenderId: "830990577812",
  appId: "1:830990577812:web:624ccd2c304b6385844481"
};


            const appId = 'default-trading-tracker';

            // --- FIREBASE INITIALIZATION ---
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            const auth = firebase.auth();

            // --- GLOBAL STATE & DOM ELEMENTS ---
            let score = 0.0, wins = 0, losses = 0, totalTrades = 0, maxWin = 0, maxLoss = 0;
            let history = [], templates = {}, savedSessionsData = [];
            let userId = null, sessionToDeleteId = null;

            const mainScoreEl = document.getElementById('main-score');
            const winsTrackerDetailEl = document.getElementById('wins-tracker-detail');
            const lossesTrackerDetailEl = document.getElementById('losses-tracker-detail');
            const tradesTrackerEl = document.getElementById('trades-tracker');
            const buttonsContainer = document.getElementById('buttons-container');
            const templateSelector = document.getElementById('template-selector');
            const themeSwitcher = document.getElementById('theme-switcher');
            const dataRingContainer = document.getElementById('data-ring');
            const ringWinsEl = document.getElementById('ring-wins');
            const ringLossesEl = document.getElementById('ring-losses');
            const liveProfitDetailEl = document.getElementById('live-profit-detail');

            const sunIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M8 11a3 3 0 1 1 0-6 3 3 0 0 1 0 6zm0 1a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2a.5.5 0 0 1 .5-.5zm-5-5a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1h-2a.5.5 0 0 1-.5-.5zm10 0a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1h-2a.5.5 0 0 1-.5-.5zM4.646 4.646a.5.5 0 0 1 .708 0l1.414 1.414a.5.5 0 0 1-.708.708L4.646 5.354a.5.5 0 0 1 0-.708zm6.364 6.364a.5.5 0 0 1 .708 0l1.414 1.414a.5.5 0 0 1-.708.708l-1.414-1.414a.5.5 0 0 1 0-.708zM4.646 11.354a.5.5 0 0 1 0-.708l1.414-1.414a.5.5 0 1 1 .708.708L5.354 11.354a.5.5 0 0 1-.708 0zM11.354 4.646a.5.5 0 0 1 0-.708l1.414-1.414a.5.5 0 1 1 .708.708L12.06 5.354a.5.5 0 0 1-.708 0z"/></svg>`;
            const moonIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"/></svg>`;
            const undoIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M8 3a5 5 0 1 1-4.546 2.914.5.5 0 0 0-.908-.417A6 6 0 1 0 8 2v1z"/><path d="M8 4.466V.534a.25.25 0 0 0-.41-.192L5.23 2.308a.25.25 0 0 0 0 .384l2.36 1.966A.25.25 0 0 0 8 4.466z"/></svg>`;
            const historyIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M8.515 1.019A7 7 0 0 0 8 1V0a8 8 0 0 1 .589.022l-.074.997zM11.985 1.795a7.002 7.002 0 0 0-3.582-1.795l.074-.997a8.001 8.001 0 0 1 4.09 2.025l-.71.71A7.001 7.001 0 0 0 11.985 1.795zM4.015 1.795a7.002 7.002 0 0 0-3.582 1.795l.71.71a7.001 7.001 0 0 0 3.582-1.795L4.015 1.795zM1.795 4.015a7.002 7.002 0 0 0-1.795 3.582l.997.074a7.001 7.001 0 0 0 1.795-3.582l-.997-.074zM14.205 4.015a7.002 7.002 0 0 0-1.795-3.582l-.71.71a7.001 7.001 0 0 0 1.795 3.582l.997-.074zM8 10a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm0 1a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/><path d="M8 5.5a.5.5 0 0 1 .5.5v2.5a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5z"/></svg>`;
            const resetIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71V3.5z"/><path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm7-8A7 7 0 1 1 1 8a7 7 0 0 1 14 0z"/></svg>`;
            const instrumentPointValues = { MES: 5, ES: 50, MNQ: 2, NQ: 20 };
            
            const applyTheme = (theme) => { document.body.className = theme; themeSwitcher.innerHTML = theme === 'dark-theme' ? sunIcon : moonIcon; localStorage.setItem('plTrackerTheme', theme); };
            const toggleTheme = () => { applyTheme(document.body.className === 'dark-theme' ? 'ice-theme' : 'dark-theme'); };
            const defaultTemplates = { 
                "ES": { instrument: "ES", pointValue: 50, commission: 4.20, positive: [0.5, 1, 1.5, 2, 2.5, 3, 3.5, 4, 4.5, 5], negative: [-2, -2.5, -3] },
                "NQ": { instrument: "NQ", pointValue: 20, commission: 4.20, positive: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10], negative: [-4, -6, -8, -10] } 
            };

            auth.onAuthStateChanged(async (user) => { if (user && !userId) { userId = user.uid; await initializeAndLoadData(); } else if (!user) { auth.signInAnonymously().catch(console.error); } });
            async function initializeAndLoadData() {
                if (!userId) return;
                const templateCollectionRef = db.collection('artifacts').doc(appId).collection('users').doc(userId).collection('templates');
                const templateSnapshot = await templateCollectionRef.get();
                if (templateSnapshot.empty) { await Promise.all(Object.entries(defaultTemplates).map(([name, data]) => templateCollectionRef.doc(name).set(data))); }
                templateCollectionRef.onSnapshot((snapshot) => { templates = {}; snapshot.forEach(doc => { templates[doc.id] = doc.data(); }); populateTemplateSelectors(); renderButtons(templateSelector.value || Object.keys(templates)[0]); });
                db.collection('artifacts').doc(appId).collection('users').doc(userId).collection('sessions').onSnapshot((snapshot) => {
                    const log = document.getElementById('sessions-log');
                    log.innerHTML = '';
                    savedSessionsData = [];
                    snapshot.forEach(doc => savedSessionsData.push({ id: doc.id, ...doc.data() }));
                    savedSessionsData.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(data => {
                        const el = document.createElement('div');
                        el.className = 'history-item p-2 rounded-md flex justify-between items-center';
                        el.innerHTML = `<div class="flex-grow"><div><span class="font-bold">${formatDate(data.date)}</span><span class="text-xs ml-2">${data.sessionTime}</span></div><div class="text-xs mt-1">${data.note}</div><div class="text-right mt-1"><span class="font-bold ${data.score >= 0 ? 'text-green-400' : 'text-red-400'}">${parseFloat(data.score).toFixed(1)}</span><span class="text-xs ml-2">W:${data.wins} L:${data.losses} T:${data.totalTrades}</span></div></div><div class="flex flex-col items-center space-y-2 ml-2"><button title="Show Stats" class="icon-btn stats-btn" data-session-id="${data.id}"><svg class="pointer-events-none" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M11 2a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v12h.5a.5.5 0 0 1 0 1H.5a.5.5 0 0 1 0-1H1v-3a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v3h1V7a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v7h1V2zm1 12h2V2h-2v12zm-3 0V7H7v7h2zm-4 0v-3H2v3h2z"/></svg></button><button title="Export to Clipboard" class="icon-btn export-btn" data-session-id="${data.id}"><svg class="pointer-events-none" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zM-1 8a.5.5 0 0 1 .5-.5h15a.5.5 0 0 1 0 1H-.5a.5.5 0 0 1-.5-.5z"/></svg></button><button title="Delete Session" class="icon-btn delete-btn" data-session-id="${data.id}"><svg class="pointer-events-none" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg></button></div>`;
                        log.appendChild(el);
                    });
                });
            }
            
            const animateValue = (element, start, end, duration) => {
                if (start === end) return;
                let startTime = null;
                const step = (currentTime) => {
                    if (!startTime) startTime = currentTime;
                    const progress = Math.min((currentTime - startTime) / duration, 1);
                    const currentValue = start + (end - start) * progress;
                    element.textContent = currentValue.toFixed(1);
                    if (progress < 1) {
                        window.requestAnimationFrame(step);
                    } else {
                        element.textContent = end.toFixed(1);
                    }
                };
                window.requestAnimationFrame(step);
            };

            const updateDataRing = () => {
                const winP = totalTrades > 0 ? (wins / totalTrades) * 100 : 0;
                const lossP = totalTrades > 0 ? (losses / totalTrades) * 100 : 0;
                ringWinsEl.style.strokeDasharray = `${winP} ${100 - winP}`;
                ringLossesEl.style.strokeDasharray = `${lossP} ${100 - lossP}`;
                ringLossesEl.style.strokeDashoffset = -winP;
            };

            const updateDisplay = (previousScore) => {
                animateValue(mainScoreEl, previousScore, score, 200);
                mainScoreEl.classList.toggle('score-glow-positive', score > 0);
                mainScoreEl.classList.toggle('score-glow-negative', score < 0);
                winsTrackerDetailEl.textContent = `W: ${wins}`;
                lossesTrackerDetailEl.textContent = `L: ${losses}`;
                tradesTrackerEl.textContent = totalTrades;
                
                const currentTemplate = templates[templateSelector.value];
                const dataRingDetails = document.querySelector('.data-ring-details');
                if (totalTrades > 0 && currentTemplate?.pointValue != null && currentTemplate?.commission != null) {
                    const profit = (score * currentTemplate.pointValue) - (totalTrades * currentTemplate.commission);
                    maxWin = Math.max(maxWin, profit);
                    maxLoss = Math.min(maxLoss, profit);
                    liveProfitDetailEl.textContent = `$${profit.toFixed(2)}`;
                    liveProfitDetailEl.classList.remove('profit-positive', 'profit-negative');
                    liveProfitDetailEl.classList.add(profit >= 0 ? 'profit-positive' : 'profit-negative');
                } else {
                    liveProfitDetailEl.textContent = '';
                }

                updateDataRing();
            };
            const handleButtonClick = (value) => { const previousScore = score; history.push({ score, wins, losses, totalTrades }); score += value; totalTrades++; if (value > 0) wins++; else if (value < 0) losses++; updateDisplay(previousScore); };
            const resetCalculator = () => { const previousScore = score; score = 0.0; wins = 0; losses = 0; totalTrades = 0; history = []; maxWin = 0; maxLoss = 0; updateDisplay(previousScore); };
            const renderButtons = (templateName) => {
                const template = templates[templateName];
                if (!template) return;
                buttonsContainer.innerHTML = '';
                const allButtons = [...(template.positive || []).sort((a, b) => a - b), 0, ...(template.negative || []).sort((a, b) => b - a)];
                allButtons.forEach(val => {
                    const button = document.createElement('button');
                    button.textContent = (val > 0 ? '+' : '') + (parseFloat(val) === parseInt(val) ? val : val.toFixed(1));
                    button.className = `calc-btn ${val > 0 ? 'btn-positive' : val < 0 ? 'btn-negative' : 'btn-neutral'}`;
                    button.onclick = () => handleButtonClick(val);
                    buttonsContainer.appendChild(button);
                });
            };
            const saveTemplateToFirestore = async (name, templateData) => { if (userId && name) await db.collection('artifacts').doc(appId).collection('users').doc(userId).collection('templates').doc(name).set(templateData); };
            const deleteTemplateFromFirestore = async (name) => { if (userId && name && Object.keys(templates).length > 1) await db.collection('artifacts').doc(appId).collection('users').doc(userId).collection('templates').doc(name).delete(); else alert("Cannot delete the last template."); };
            const populateTemplateSelectors = () => {
                const currentMainVal = templateSelector.value;
                const editSelector = document.getElementById('template-edit-selector');
                templateSelector.innerHTML = '';
                editSelector.innerHTML = '<option value="" disabled selected>Select or Add New</option><option value="_new">-- Add New Template --</option>';
                const sortedNames = Object.keys(templates).sort();
                sortedNames.forEach(name => { const option = new Option(name, name); templateSelector.add(option.cloneNode(true)); editSelector.add(option); });
                templateSelector.value = templates[currentMainVal] ? currentMainVal : (sortedNames[0] || '');
                editSelector.value = "";
            };
            const saveSessionToFirestore = async (sessionData) => { if(userId) await db.collection('artifacts').doc(appId).collection('users').doc(userId).collection('sessions').add(sessionData); };
            const deleteSession = async (sessionId) => { if (userId && sessionId) await db.collection('artifacts').doc(appId).collection('users').doc(userId).collection('sessions').doc(sessionId).delete(); };
            const wipeAllSessions = async () => { if (!userId) return; const snapshot = await db.collection('artifacts').doc(appId).collection('users').doc(userId).collection('sessions').get(); await Promise.all(snapshot.docs.map(d => d.ref.delete())); };
            const formatDate = (isoDate) => { if (!isoDate || typeof isoDate !== 'string' || isoDate.length < 10) return ''; const [y, m, d] = isoDate.split('-'); return `${d}/${m}/${y}`; };
            const exportSession = (sessionId, buttonEl) => { const session = savedSessionsData.find(s => s.id === sessionId); if (session) copyToClipboard([formatDate(session.date), session.note, session.sessionTime, session.score, session.wins, session.losses, session.totalTrades, session.maxLoss || 0].join('\t'), buttonEl); };
            const exportAllSessions = (buttonEl) => { if (savedSessionsData.length > 0) copyToClipboard(savedSessionsData.map(s => [formatDate(s.date || ''), s.note || '', s.sessionTime || '', s.score ?? 0, s.wins ?? 0, s.losses ?? 0, s.totalTrades ?? 0, s.maxLoss ?? 0].join('\t')).join('\n'), buttonEl); };
            const showStatsModal = (sessionId) => { const session = savedSessionsData.find(s => s.id === sessionId); if (!session) return; const statsModal = document.getElementById('stats-modal'); statsModal.dataset.sessionId = sessionId; updateStatsDisplay(session); statsModal.classList.add('active'); };
            const updateStatsDisplay = (session) => {
                const { score, totalTrades, wins, losses, instrument, pointValue, commission, maxWin, maxLoss } = session;
                const display = document.getElementById('stats-display');
                
                const profit = (score * pointValue) - (totalTrades * commission);
                const gross = score * pointValue;
                const retention = gross !== 0 ? (profit / gross) * 100 : 0;
                const winRate = (wins + losses) > 0 ? (wins / (wins + losses)) * 100 : 0;

                display.innerHTML = `
                    <div class="stats-card history-item p-4 rounded-lg text-center space-y-3">
                        <div class="font-bold text-lg">${instrument || 'N/A'}</div>
                        <div class="grid grid-cols-1 gap-3 text-left">
                            <div class="flex justify-between items-baseline"><span class="stats-label">Net Profit:</span><span class="stats-value ${profit >= 0 ? 'profit-positive' : 'profit-negative'}">$${profit.toFixed(2)}</span></div>
                            <div class="flex justify-between items-baseline"><span class="stats-label">Max Win:</span><span class="stats-value profit-positive">$${(maxWin || 0).toFixed(2)}</span></div>
                            <div class="flex justify-between items-baseline"><span class="stats-label">Max Loss:</span><span class="stats-value profit-negative">$${(maxLoss || 0).toFixed(2)}</span></div>
                            <div class="flex justify-between items-baseline"><span class="stats-label">Retention:</span><span class="stats-value">${retention.toFixed(1)}%</span></div>
                            <div class="flex justify-between items-baseline"><span class="stats-label">Win Rate:</span><span class="stats-value">${winRate.toFixed(1)}%</span></div>
                        </div>
                    </div>
                `;
            };
            const copyToClipboard = (text, buttonEl) => {
                const textArea = document.createElement('textarea');
                textArea.value = text; document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    if (buttonEl) {
                        const originalContent = buttonEl.innerHTML;
                        buttonEl.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="text-green-400 pointer-events-none" viewBox="0 0 16 16"><path d="M12.736 3.97a.733.733 0 0 1 1.047 0c.286.289.29.756.01 1.05L7.88 12.01a.733.733 0 0 1-1.065.02L3.217 8.384a.757.757 0 0 1 0-1.06.733.733 0 0 1 1.047 0l3.052 3.093 5.4-6.425a.247.247 0 0 1 .02-.022z"/></svg>';
                        setTimeout(() => { buttonEl.innerHTML = originalContent; }, 2000);
                    }
                } catch (err) { console.error('Copy failed', err); }
                document.body.removeChild(textArea);
            };

            const setupEventListeners = () => {
                themeSwitcher.addEventListener('click', toggleTheme);
                dataRingContainer.addEventListener('click', () => dataRingContainer.classList.toggle('show-details'));
                templateSelector.addEventListener('change', (e) => renderButtons(e.target.value));
                document.getElementById('undo-btn').addEventListener('click', () => { if (history.length > 0) { const lastState = history.pop(); Object.assign(window, { score: lastState.score, wins: lastState.wins, losses: lastState.losses, totalTrades: lastState.totalTrades }); updateDisplay(score); } });
                document.getElementById('history-btn').addEventListener('click', () => document.getElementById('saved-sessions-container').classList.toggle('hidden'));
                
                document.querySelectorAll('[id$="-btn"]').forEach(btn => {
                    if (btn.id === 'export-all-btn') return;
                    const modalId = btn.id.replace('-btn', '-modal');
                    const modal = document.getElementById(modalId);
                    if(modal) btn.addEventListener('click', () => modal.classList.add('active'));
                });
                document.querySelectorAll('[id^="cancel-"], [id^="close-"], [id^="confirm-"]').forEach(btn => {
                    const modalId = btn.id.replace(/^(cancel-|confirm-|close-)/, '').replace('-btn', '') + '-modal';
                    const modal = document.getElementById(modalId);
                    if(modal) btn.addEventListener('click', () => modal.classList.remove('active'));
                });

                document.getElementById('confirm-reset-btn').addEventListener('click', () => { resetCalculator(); });
                document.getElementById('confirm-delete-session-btn').addEventListener('click', () => { if(sessionToDeleteId) deleteSession(sessionToDeleteId); sessionToDeleteId = null; });
                document.getElementById('update-calc-btn').addEventListener('click', () => { const values = document.getElementById('calc-input').value.trim().split(' ').map(Number).filter(n => !isNaN(n)); resetCalculator(); history = []; values.forEach(val => handleButtonClick(val)); });
                document.getElementById('confirm-save-btn').addEventListener('click', async () => { 
                    const currentTemplate = templates[templateSelector.value];
                    if (!currentTemplate) { alert("Please select a valid template."); return; }
                    let sessionTime = document.getElementById('session-time-selector').value; 
                    if (sessionTime === 'Custom') { const start = document.getElementById('start-time').value; const end = document.getElementById('end-time').value; sessionTime = (start && end) ? `${start}-${end}` : 'Custom'; } 
                    if (!document.getElementById('save-date').value) return; 
                    await saveSessionToFirestore({ note: document.getElementById('save-note').value || 'No note', date: document.getElementById('save-date').value, sessionTime, score, wins, losses, totalTrades, instrument: currentTemplate.instrument, pointValue: currentTemplate.pointValue, commission: currentTemplate.commission, maxWin, maxLoss }); 
                });
                document.getElementById('confirm-wipe-btn').addEventListener('click', () => { wipeAllSessions(); });
                document.getElementById('sessions-log').addEventListener('click', (e) => { const btn = e.target.closest('.delete-btn, .export-btn, .stats-btn'); if (!btn) return; const sessionId = btn.dataset.sessionId; if (btn.classList.contains('delete-btn')) { sessionToDeleteId = sessionId; document.getElementById('delete-session-modal').classList.add('active'); } else if (btn.classList.contains('export-btn')) { exportSession(sessionId, btn); } else if (btn.classList.contains('stats-btn')) { showStatsModal(sessionId); } });
                document.getElementById('session-time-selector').addEventListener('change', (e) => document.getElementById('custom-time-inputs').classList.toggle('hidden', e.target.value !== 'Custom'));
                
                document.getElementById('instrument-selector').addEventListener('change', (e) => {
                    document.getElementById('point-value-display').textContent = `$${instrumentPointValues[e.target.value]}`;
                });
                
                document.getElementById('template-edit-selector').addEventListener('change', (e) => { const s = e.target.value, n = document.getElementById('template-name-input'), pv = document.getElementById('point-value-display'), p = document.getElementById('positive-buttons-input'), g = document.getElementById('negative-buttons-input'), d = document.getElementById('delete-template-btn'), i = document.getElementById('instrument-selector'), c = document.getElementById('commission-input'); if (s === '_new') { [n, p, g, c].forEach(el => el.value = ''); i.value = 'MES'; pv.textContent = `$${instrumentPointValues.MES}`; n.disabled = false; d.classList.add('hidden'); } else if (templates[s]) { n.value = s; n.disabled = true; i.value = templates[s].instrument || 'MES'; pv.textContent = `$${templates[s].pointValue || instrumentPointValues.MES}`; c.value = templates[s].commission || ''; p.value = templates[s].positive.join(', '); g.value = templates[s].negative.join(', '); d.classList.remove('hidden'); } });
                document.getElementById('save-template-btn').addEventListener('click', async () => { const name = document.getElementById('template-name-input').value.trim(); const instrument = document.getElementById('instrument-selector').value; const pointValue = instrumentPointValues[instrument]; const commission = parseFloat(document.getElementById('commission-input').value); if (!name || !instrument || isNaN(commission)) { alert('Template Name, Instrument, and Commission are required.'); return; } const positive = document.getElementById('positive-buttons-input').value.split(',').map(s => parseFloat(s.trim())).filter(n => !isNaN(n) && n >= 0); const negative = document.getElementById('negative-buttons-input').value.split(',').map(s => parseFloat(s.trim())).filter(n => !isNaN(n) && n <= 0); if(!positive.length && !negative.length) return; await saveTemplateToFirestore(name, { instrument, pointValue, commission, positive, negative }); document.getElementById('edit-templates-modal').classList.remove('active'); });
                document.getElementById('delete-template-btn').addEventListener('click', async () => { if(confirm(`Delete template?`)) { await deleteTemplateFromFirestore(document.getElementById('template-name-input').value); document.getElementById('edit-templates-modal').classList.remove('active'); } });
                document.getElementById('export-all-btn').addEventListener('click', (e) => exportAllSessions(e.currentTarget));

                // Set initial icons
                document.getElementById('undo-btn').innerHTML = undoIcon;
                document.getElementById('history-btn').innerHTML = historyIcon;
                document.getElementById('reset-btn').innerHTML = resetIcon;
                document.getElementById('export-all-btn').innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/></svg>`;
                document.getElementById('wipe-sessions-btn').innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="text-red-500 hover:text-red-400" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>`;
                document.getElementById('close-stats-btn').innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg>`;
            };
            
            // Initial setup
            applyTheme(localStorage.getItem('plTrackerTheme') || 'dark-theme');
            setupEventListeners();
        });
    </script>

</body>
</html>
